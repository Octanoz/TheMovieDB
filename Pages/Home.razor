@page "/"
@inject TMDBClient TMDB
@inject NavigationManager Navigation
@using MudBlazor

<PageTitle>Home</PageTitle>

<MudBreakpointProvider OnBreakpointChanged="OnBreakpointChanged">
    <MudHidden Breakpoint="Breakpoint.MdAndUp" Invert="true">
        <MudText Typo="Typo.h3" Class="ma-6">Popular Movies</MudText>
    </MudHidden>
</MudBreakpointProvider>
<MudBreakpointProvider>
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudText Typo="Typo.h4" Class="ma-6">Popular Movies</MudText>
    </MudHidden>
</MudBreakpointProvider>

@if (popularMovies is not null)
{
    <MudContainer Class="d-flex justify-center my-4">
        <MudPagination Color="Color.Secondary" Size="@(isSmallScreen ? Size.Small : Size.Medium)" BoundaryCount="1" MiddleCount="2" Count="500" Selected="CurrentPage" SelectedChanged="OnPageChanged" />
    </MudContainer>
    <MudGrid Spacing="6" Class="px-12">
        @foreach(var movie in popularMovies.Results)
        {
            <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
                <MudContainer Class="px-0" Style="width: min(105%, 342px);">
                    <MudPaper Elevation="5" Class="mud-theme-secondary d-flex align-center justify-center mud-width-full rounded-lg pa-3">
                        @if (isSmallScreen)
                        {
                            <PopularMovieCardLandscape Movie="@movie" />
                        }
                        else
                        {
                            <PopularMovieCard Movie="@movie" />
                        }
                    </MudPaper>
                </MudContainer>
            </MudItem>
        }
    </MudGrid>
    <MudContainer Class="d-flex justify-center my-4">
        <MudPagination Color="Color.Secondary" Size="@(isSmallScreen ? Size.Small : Size.Medium)" BoundaryCount="1" MiddleCount="2" Count="500" Selected="CurrentPage" SelectedChanged="OnPageChanged" />
    </MudContainer>
}
else
{
    <MudGrid Spacing="6" Class="px-12">
    @for (int i = 0; i < 12; i++)
    {
        <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
            <MudCard>
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="700" />
                <MudCardContent>
                    <MudSkeleton Class="mx-auto" Width="30%" Height="400px" />
                    <MudSkeleton Width="80%" />
                    <MudSkeleton Width="100%" />
                </MudCardContent>
                <MudCardActions>
                    <MudSkeleton Width="64px" Height="40px" Class="ml-2" />
                    <MudSkeleton Width="105px" Height="40px" Class="ml-3" />
                </MudCardActions>
            </MudCard>
        </MudItem>
    }
    </MudGrid>
}

@code {
    PopularMoviesPagedResponse? popularMovies;

    [SupplyParameterFromQuery]
    public int CurrentPage { get; set; }

    bool isSmallScreen = false;

    private void OnBreakpointChanged(Breakpoint breakpoint)
    {
        isSmallScreen = breakpoint <= Breakpoint.Sm;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        if (CurrentPage <= 0)
            CurrentPage = 1;

        await LoadPopularMovies();
    }

    private async Task OnPageChanged(int page)
    {
        CurrentPage = Math.Clamp(page, 1, 500);
        string url = Navigation.GetUriWithQueryParameter("CurrentPage", CurrentPage);
        Navigation.NavigateTo(url);
        await LoadPopularMovies();
    }

    private async Task LoadPopularMovies()
    {
        popularMovies = await TMDB.GetPopularMoviesPagedResponseAsync(CurrentPage);
        StateHasChanged();
    }
}